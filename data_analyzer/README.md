# Lunaris Data Analyzer (`lunaris_data_analyzer`)

**Version: 0.2.0**

`lunaris_data_analyzer` is a C++ command-line utility designed to inspect, validate, and analyze tokenized dataset files in the `.memmap` format used by the Lunaris Codex project (as generated by `prepare_data.py`).

It provides a fast way to verify dataset integrity, understand token distributions, and view raw token sequences, leveraging memory-mapping (`mmap`) on Linux for efficient file handling.

## Features

-   **File Validation:** Verifies that the `.memmap` file size matches the expected dimensions (number of sequences, max sequence length, and data type).
-   **Memory-Mapped Reading:** Uses `mmap` on Linux for efficient access to large dataset files. Includes an `ifstream` fallback for basic sequence printing on other systems or for testing (full statistics are best with `mmap`).
-   **Data Statistics:**
    -   Total token count.
    *   Count and percentage of a **user-specified padding token ID** (via `--pad_id`, defaults to `0`).
    *   Count of out-of-vocabulary tokens (if `--vocab_size` is provided).
    *   Frequency report for the top N most common tokens.
-   **Sequence Inspection:** Prints the first N token ID sequences from the dataset.
-   **Configurable:** All operations are controlled via command-line arguments.

## Prerequisites

-   A C++17 compatible compiler (e.g., `g++`, `clang++`).
-   Standard C++ libraries.
-   For `mmap` functionality: A POSIX-compliant system (primarily tested on Linux).
-   `std::filesystem` support (C++17).

## Compilation

Navigate to the `data_analyzer/` directory containing `lunaris_data_analyzer.cpp` and compile using a C++17 compiler:

```bash
g++ lunaris_data_analyzer.cpp -o lunaris_data_analyzer -std=c++17 -O2
```
*The `-O2` flag enables optimizations, which is recommended for performance.*

On some older Linux systems or specific toolchains, you *might* need to link the filesystem library explicitly if you encounter linker errors related to `std::filesystem`:
```bash
g++ lunaris_data_analyzer.cpp -o lunaris_data_analyzer -std=c++17 -O2 -lstdc++fs
```

## Usage

Run the compiled executable from your terminal, providing the necessary arguments:

```bash
./lunaris_data_analyzer --file <path_to_memmap> \
                        --num_sequences <count> \
                        --max_length <length> \
                        [--dtype <int32|int16>] \
                        [--pad_id <id_value>] \
                        [--vocab_size <size>] \
                        [--print_seq <num>] \
                        [--top_n_tokens <num>] \
                        [--no_mmap] \
                        [--help]
```

### Command-Line Arguments:

*   `--file <path>`: **(Required)** Path to the `.memmap` file generated by `prepare_data.py`.
*   `--num_sequences <long>`: **(Required)** Expected number of sequences in the dataset.
*   `--max_length <int>`: **(Required)** Expected maximum length of each sequence.
*   `--dtype <str>`: (Optional) Data type of the tokens in the memmap file.
    *   Options: `int32`, `int16`.
    *   Default: `int32`.
*   `--pad_id <long>`: (Optional) The token ID used for padding in the dataset. This ID will be used for calculating padding statistics.
    *   Default: `0`.
*   `--vocab_size <int>`: (Optional) Expected vocabulary size. If provided, tokens outside the range `[0, vocab_size-1]` will be counted as "out-of-vocabulary".
    *   Default: `-1` (validation disabled).
*   `--print_seq <num>`: (Optional) Number of initial sequences to print to the console.
    *   Default: `3`. Set to `0` to disable sequence printing if only statistics are desired (though 1 sequence might still print if mmap is used for stats calculation).
*   `--top_n_tokens <num>`: (Optional) Report the frequency of the top N most common tokens.
    *   Default: `0` (disabled). Only effective when `mmap` is used.
*   `--no_mmap`: (Optional) Disable the use of memory-mapping (`mmap`) and use standard `ifstream` for reading. This is significantly slower for full-file statistics but can be useful for basic sequence printing on non-Linux systems or for debugging. When using this option, detailed statistics like padding percentage and top N tokens are not computed.
*   `-h`, `--help`: Display this help message and exit.

### Example:

Analyze a dataset where the padding token ID is `50256`, validate against a vocab size of `49152`, print the first `2` sequences, and report the `5` most common tokens:

```bash
./lunaris_data_analyzer \
    --file ./processed_data/my_dataset.memmap \
    --num_sequences 10000 \
    --max_length 1024 \
    --dtype int32 \
    --pad_id 50256 \
    --vocab_size 49152 \
    --print_seq 2 \
    --top_n_tokens 5
```

## Notes

-   Full statistical analysis (padding count, top N tokens, OOV count) is most efficiently performed when memory-mapping (`mmap`) is used, as it allows easy access to the entire dataset. The `--no_mmap` option primarily supports basic sequence printing and does not compute these detailed statistics.

---
